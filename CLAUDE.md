# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Memories
- Run date via bash before adding/editing any documentation to ensure you've got the correct date.
- GK Rating Feature added (2025-10-08): Fourth rating metric for goalkeeper ability. Measures shot-stopping, positioning, distribution, command of area, and 1v1 ability on 0-10 scale (displayed as 0-5 stars). Database columns: `gk_rating` in player_ratings table, `gk` and `average_gk_rating` in players table. Trigger function `update_player_average_ratings()` updated to calculate GK averages. UI components updated: Ratings.tsx (rating modal + display), RatingsExplanation.tsx (ðŸ¥… GK section), PlayerRatingsTable.tsx, admin hooks (usePlayerRatings, useRaterStats), PlayerProfile.tsx, EditPlayer.tsx. GK rating follows same null-safe pattern as other ratings using formatRating() utility. Currently not included in team balancing algorithm - intended for formation suggestions/goalkeeper rotation decisions in 9v9 games.
- Academy tier added (2025-06-18): Players with 0 caps and 0 XP are now "Academy" (deep teal gradient), while players with >0 caps and 0 XP remain "Retired" (black). This distinction helps differentiate new players from inactive ones.
- When the user wants to commit changes to GitHub, ask if they'd like to use the Git MCP server commands instead of bash git commands.
- Team Announcement Phase enhanced (2025-06-18): Now supports two-stage pasting - first paste player registration message, then team announcement message with ðŸŸ  Orange Team and ðŸ”µ Blue Team sections. Attack/Defense ratings removed from game creation form. Default pitch cost updated to Â£54.
- Game IQ Rating added (2025-06-26): Third rating metric alongside Attack and Defense. Measures tactical awareness, positioning, and decision-making (0-10 scale, displayed as 0-5 stars). Team balancing now uses 5 metrics with 20% weighting each: Attack, Defense, Game IQ, Win Rate, Goal Differential. Database columns: `game_iq_rating` in player_ratings, `game_iq` and `average_game_iq_rating` in players table.
- Game IQ Implementation Details (2025-06-26): When working with player ratings, always handle null values using nullish coalescing (`??`) or optional chaining (`?.`). The admin ratings page uses OR logic for filtering (shows players with at least one non-zero rating). Rating interfaces must include `gameIq` in addition to `attack` and `defense`. All player rating displays should show Game IQ alongside Attack and Defense ratings.
- Game IQ Display Improvements (2025-06-26): Unrated values show as "unrated" instead of "0" or "NaN". Created `formatRating()` and `formatStarRating()` helper functions in `/src/utils/ratingFormatters.ts`. Rating buttons show contextual text: "ADD GAME IQ RATING" when only Game IQ is missing, "COMPLETE RATING" when multiple ratings are missing, "UPDATE RATING" when all ratings exist.
- Changelog Management: Version 1.2.0 added for Game IQ feature. When documenting team balancing changes in user-facing content, keep algorithm details vague to prevent gaming the system. Players can rate other players (not just teammates) after playing 5+ games together.
- Ratings Explanation Component (2025-06-26): Added expandable/collapsible explanation section to ratings page using Framer Motion. Component path: `/src/components/ratings/RatingsExplanation.tsx`. Explains that ratings should consider both skill AND position tendency (e.g., a skilled defender who rarely plays defense should have a lower defense rating). Emphasizes confidentiality and importance of honest ratings. Keep algorithm details vague - only mention it "considers multiple factors beyond just ratings" without specifics.
- Admin Ratings Page Fix (2025-06-26): Fixed Game IQ ratings not displaying in admin panel. Issue was in `useRaterStats` hook missing `game_iq_rating` in select query. Also added `updated_at` column to `player_ratings` table with auto-update trigger, so admin can see when ratings were last modified instead of just creation date.
- Changelog Deep Linking (2025-06-26): Added URL fragment support to link directly to specific changelog versions. Access via `http://localhost:5173/changelog#1.2.0` format. The linked version auto-expands with all sections (Added/Changed/Fixed) visible. Implementation uses refs to control DaisyUI collapse component state. Existing "Expand All"/"Collapse All" functionality remains intact.
- Rating History System (2025-06-27): Implemented player_ratings_history table to track all rating changes. Database trigger automatically logs INSERT and UPDATE operations. Recent Activity now shows rating changes with visual indicators: ðŸŸ¢â†‘ for increases, ðŸ”´â†“ for decreases. Changes display the amount (e.g., "+2", "-1"). History table has RLS policies: INSERT allowed for trigger operations, SELECT limited to admins only. Fixed RLS policy error by adding "Allow trigger to insert history" policy. User-specific activity filtering available when selecting a rater. Recent Activity section on admin ratings page shows most recent changes at top with mobile-responsive design.
- Admin Players Page Mobile Improvements (2025-06-26): Made admin players management page mobile-friendly. Key changes: responsive header controls with stacked layout, mobile-optimized search bar (full width), abbreviated button labels on mobile, hidden table columns (Caps/XP) with inline badges, mobile-specific "Select All" button, improved touch targets with appropriate sizing (btn-sm/btn-xs), reduced container padding. Pattern can be applied to other admin pages for consistency.
- Role-Based Access Control (RBAC) System (2025-06-26): Implemented granular permissions for admins. Database: `roles` table for named roles, `role_permissions` for role-permission mappings, `role_id` added to `admin_roles`. Created 5 default roles: Super Admin (all permissions), Full Admin (all except admin/ratings management), Treasurer (payments only), Team Manager (games/teams), Player Manager (players/tokens). 10 permissions available: manage_games, manage_players, manage_teams, manage_payments, manage_history, manage_tokens, manage_accounts, manage_slots, manage_admins (super only), manage_ratings (super only). Backward compatible with existing `is_admin` and `is_super_admin` flags.
- RBAC UI Implementation (2025-06-26): Role management at `/admin/roles` for super admins only. Admin management page redesigned with stats header, role assignment, search functionality, and improved layout. Uses custom expandable sections instead of DaisyUI collapse for View Permissions due to rendering issues with dynamic content. Admin cards show role badges: red for Super Admin, blue for Full Admin, purple for role-based with role name. Grid layout: 1 col mobile, 2 col medium, 3 col large, 4 col extra-large screens.
- RBAC Permission Checking (2025-06-26): Updated `useAdmin` hook to include `hasPermission(permission)` and `permissions[]`. Admin portal shows only permitted sections. Payment dashboard example: checks `PERMISSIONS.MANAGE_PAYMENTS` before allowing access. Permission constants in `/src/types/permissions.ts`. Admin fetching uses two queries (players + admin_roles) combined in memory to handle all admin types correctly.
- View As Feature (2025-06-26): Super admins can emulate other admin users' permissions via "View As" button in admin management. Implementation: ViewAsContext (`/src/context/ViewAsContext.tsx`) manages emulated state, useAdmin hook checks for overrides, ViewAsIndicator shows warning banner. Access via Admin Portal â†’ Admin Management â†’ View As button. Exit via banner button returns to normal permissions.
- Player Rating Decimal Precision Fix (2025-06-27): Fixed issue where average ratings were stored as integers after Game IQ implementation. Root cause: bulk update rounded averages (e.g., 4.0 instead of 3.29). Solution: Applied migration to recalculate all averages from individual ratings. The trigger function `update_player_average_ratings()` was already correct and maintains decimal precision for all future updates. Documentation: `/docs/fixes/RatingDecimalPrecisionFix.md`.
- Game IQ Team Balancing Fix (2025-06-30): Fixed Game IQ not being fetched or displayed in team balancing. Issues: `useTeamBalancing` hook wasn't querying `game_iq` from database, OptimalTeamGenerator and SwapSuggestion components didn't show Game IQ, values were defaulting to 5. Fixed by: adding `game_iq` and `average_game_iq_rating` to database query, updating all components to display Game IQ with null-safe operators (`??`), adding Game IQ to team stats calculations with proper weighting. All rating interfaces updated to handle null values, using `formatRating()` utility to display "unrated" for null values.
- Unknown Player Distribution in Team Balancing (2025-06-30): Enhanced team generation algorithm to distribute players with unknown stats (< 10 games) evenly across teams. Previously, unknowns could cluster on one team, disabling win rate/goal differential metrics. New two-phase approach: Phase 1 distributes unknowns evenly, Phase 2 optimizes experienced players. Added UI indicators: "NEW" badges for < 10 game players, team headers show new player count, confidence score (high/medium/low) based on unknown percentage. Helper function `isUnknownPlayer()` in teamBalanceUtils.ts identifies players with insufficient data.
- Deterministic Unknown Distribution (2025-06-30): Fixed non-deterministic team generation. Previous implementation used random shuffling for unknowns. New approach: Phase 1 finds OPTIMAL distribution of unknowns by trying all combinations and selecting best Attack/Defense/Game IQ balance. Uses `generateCombinationsOfSize()` to generate all possible splits, `calculatePartialBalanceScore()` to evaluate based on 3 known metrics only, `findOptimalUnknownDistribution()` to select best split. Result: same optimal configuration every time, unknowns distributed based on their actual stats, truly deterministic algorithm.
- All Ratings Average Calculation Fix (2025-07-08): Fixed issue where Attack, Defense, and Game IQ ratings were storing individual values instead of averages. Examples: Zhao's Game IQ showed 2 instead of 4 (avg of 2,3,5,6), Mike M's Attack showed 0 instead of 5.29. Root cause: incorrect data values, not the trigger function. Solution: Applied migration to recalculate all rating averages using AVG() function. Trigger verified working correctly for future updates. Documentation: `/docs/fixes/GameIQAverageCalculationFix.md`.
- Rating Average Overwrite Issue (2025-07-10): Discovered and fixed critical bug where player rating averages were being overwritten with individual rating values. When Daniel submitted ratings, stored averages became his exact ratings (e.g., Nathan: 5/3/4 instead of 6.33/6.0/5.8). Root cause still under investigation but likely related to trigger execution or race conditions. Fix: Created audit logging system (`player_rating_audit` table), enhanced trigger function with debugging, recalculated all averages. Monitoring in place to identify exact cause if issue recurs. Documentation: `/docs/fixes/RatingAverageOverwriteIssue.md`.
- Team Balancing Tier Visualization Enhancement (2025-07-17): Improved tier pyramid visualization in team balancing. Player names now appear directly under each specific tier when clicked (previously appeared at bottom of all tiers). Multiple tiers can be expanded simultaneously for comparison. Added "Expand All" and "Collapse All" buttons. Fixed animation issues by creating isolated TierItem components with React.memo() to prevent re-renders. Each tier maintains its own state with smooth Framer Motion animations. Located in `/src/components/admin/team-balancing/visualizations/TierDistributionVisual.tsx`.
- True Snake Draft Implementation (2025-07-17): Fixed tier-based team balancing to use proper snake draft pattern. Previously Blue always picked first in Tier 1 and alternation only occurred with odd player counts. Now: randomly selects which team picks first initially (different each time), then alternates which team picks first in each subsequent tier regardless of player count. This ensures fair distribution - the highest-rated player won't always go to the same team. Debug log shows which team was randomly selected. Updated `applySnakeDraft()` in `tierBasedSnakeDraft.ts`.
- Snake Draft Team Balance Fix (2025-07-17): Fixed issue where true snake draft could create imbalanced teams (e.g., 10v8 instead of 9v9). Algorithm now: pre-calculates if standard snake draft would create imbalance, adjusts pick order in final tiers if teams are getting too uneven, ensures no team exceeds target size (total players / 2), shows warnings and adjustments in debug log. Maintains snake draft fairness while guaranteeing balanced team sizes.
- Tier Distribution Awareness (2025-07-23): Enhanced tier-based snake draft to prevent extreme quality concentrations within tiers. Problem: One team could get all worst players in a tier (e.g., Blue gets both James H and Mike M in Tier 5). Solution: Added quality concentration detection for tiers with 3+ players and rating spread > 1.2. New functions: `validateTierDistribution()` checks both count and quality issues, `getTierDistributionIssues()` provides specific problem details, `isSwapAcceptable()` allows swaps that don't worsen existing concentrations. Changed balance threshold from 0.5 to 0.3. Algorithm now prevents teams from getting all bottom players in any tier while still allowing beneficial optimization. Debug log shows detailed tier distribution status and rejection reasons.
- Game IQ Column Naming Fix (2025-08-27): Fixed EditPlayer.tsx incorrectly using `game_iq_rating` when updating the players table, causing 400 error "Could not find the 'game_iq_rating' column of 'players' in the schema cache". The correct column name in the players table is `game_iq` for the default/manual rating value (with `average_game_iq_rating` for the calculated average). Note: The player_ratings table correctly uses `game_iq_rating` for individual rating submissions. Updated EditPlayer.tsx to use `game_iq` for both the type definition and database update operations.
- Game Creation Form Improvements (2025-08-27): Enhanced WhatsApp game import parsing: 1) Fixed player count issue where "Anyone needs to drop out" text was counted as a player - parser now stops at empty lines. 2) Added player name validation to reject non-player text (phrases like "drop out", "let me know", etc.). 3) Updated default pitch cost to Â£56.70 (Â£3.15 per player for 18 players). 4) Added database matching validation showing matched vs unmatched players with warning when players can't be found (e.g., "Tom" needs to be manually selected as "Tom K"). 5) Added player counts to multi-select labels in PlayerSelectionDetails (e.g., "Selected Players (18)"). Parser properly handles ðŸ”„ replacement symbol within player lists.
- Beta Tester Feature (2025-09-05): Implemented beta tester functionality for controlled rollout of new features. Allows admins to grant early access to selected users via Account Management page. Full documentation: `/docs/features/BetaTesterFeature.md`
- Playstyle Rating System (2025-09-05, Live 2025-09-17): Implemented comprehensive playstyle system with 24 playstyles (8 attacking, 9 midfield, 7 defensive) that derive 6 attributes (Pace, Shooting, Passing, Dribbling, Defending, Physical). Each playstyle has weights totaling 2.0 for perfect balance. Default attribute value is 0 (changed from 0.35). Playstyles complement Attack/Defense/Game IQ ratings by showing HOW players use their skills. Initially beta-restricted, now available to all users (2025-09-17). Database: `playstyles` table with definitions, `player_derived_attributes` table with averaged values, trigger function auto-calculates attributes. UI: PlaystyleSelector component shows percentage distribution totaling 100%, attribute-based filtering to find matching playstyles, display format uses colon (e.g., "Speedster: Pace + Dribbling"). Mobile responsive with compact abbreviations. Team balancing: 60% core ratings, 20% derived attributes, 20% performance (updated 2025-09-08). Includes 3 new playstyles: Speedster (Pace + Dribbling), Locomotive (Pace + Physical), Enforcer (Dribbling + Physical). Full documentation: `/docs/features/PlaystyleRatingSystem.md`
- Team Balancing Algorithm Calibration Fix (2025-09-08): Fixed critical issue where all players received positive attribute adjustments instead of relative mix of positive/negative like before playstyles. Root cause: attributes provided pure positive adjustments (0-1 scale) rather than league-relative adjustments. Solution: Implemented statistical z-score scaling using league standard deviations to create meaningful relative adjustments ranging Â±0.05 to Â±0.3 (50-75x more impactful than previous Â±0.001 to Â±0.004). Weight rebalancing: reduced attributes from 30% to 20%, increased performance from 10% to 20% to ensure catastrophic performers (<30% win rate) still get meaningful penalties. Enhanced with exponential performance penalties, dynamic balance thresholds, and relaxed tier concentration rules (1.2 â†’ 1.5). Located in `tierBasedSnakeDraft.ts` with new `calculateLeagueAttributeStats()` function.
- Team Balancing Algorithm Improvements (2025-09-10): Enhanced fairness and transparency of team balancing. Key improvements: 1) **Performance Adjustment Caps**: Limited rating adjustments to Â±15% of base rating to prevent excessive penalties (e.g., Nathan and James H previously lost 22% of rating). 2) **Attribute Balance Constraints**: Added ATTRIBUTE_BALANCE_THRESHOLD (0.5) to prevent teams with drastically different playstyles. Swaps creating attribute imbalance > 0.5 are rejected unless improvement > 0.2. Increased attribute weight from 20% to 30% in balance calculations. 3) **Detailed Debug Logging**: Shows specific metric changes (e.g., "Atk:0.30â†’0.03, Def:0.27â†’0.19") instead of generic messages. Rejection reasons now explicit (e.g., "attribute imbalance 2.24 > 0.5"). KEY DECISIONS section enhanced with actual before/after values. Located in `tierBasedSnakeDraft.ts` with new `generateImprovementDetails()` function.
- Payment Dashboard Query Limit Fix (2025-09-11): Fixed issue where games with many registrations (especially game #63) showed incorrect cost per player and 0 players. Root cause: Supabase IN query hitting 1000 record limit when fetching 63+ games. Solution: Batch fetch registrations in groups of 10 games, limit dashboard to 30 most recent games. Also fixed CORS by setting Vite server port to 5175. Files: PaymentDashboard.tsx, GamePaymentStats.tsx, vite.config.ts. Documentation: `/docs/fixes/PaymentSplittingQueryLimitFix.md`.
- Player Card Recent Games Query Limit Fix (2025-10-09): Fixed "Last 40 Games" statistic showing incorrect counts due to Supabase's 1000 row limit. Player cards were displaying 8-10 fewer games than reality (e.g., Chris H: 28 shown vs 36 actual, Daniel: 27 vs 37). Root cause: Query fetched ALL game registrations (1,175+ rows) then filtered in JavaScript, but Supabase truncated to 1,000 rows. Solution: Restructured to sequential queries - first fetch last 40 game IDs, then fetch only registrations for those games (~718 rows). Applied to both usePlayerGrid.ts and useGameRegistrationStats.ts. Simplified calculation logic since data is pre-filtered. Documentation: `/docs/fixes/RecentGamesQueryLimitFix.md`, `/docs/components/PlayerCard.md`.
- Reserve Status Visualization (2025-10-09): Enhanced "Last 40 Games" statistic to show not just games played, but also reserve appearances (registered but not selected). Data structure: `gameParticipation` changed from boolean[] to `Array<'selected' | 'reserve' | null>` tracking status for each of 40 games. Visual: GameParticipationWheel component with 40 SVG segments - colored (rarity-based) for selected, white for reserve, dim for didn't register. Display adapts conditionally: shows "37/5" format when reserves exist (37 played, 5 reserve), just "37" when no reserves. Label shows "Last 40 Games Played" or "Last 40 Games Played/Reserve" based on reserve presence. Query optimization: sequential fetch (40 game IDs, then registrations for those games) fetches both 'selected' and 'reserve' statuses in single query. Component: `src/components/player-card/GameParticipationWheel.tsx` with rarity-based coloring from `src/utils/rarityColors.ts`. Benefits: visualizes player commitment patterns, shows when registered but not picked, provides activity timeline. Documentation: `/docs/features/ReserveStatusVisualization.md`.
- Feature Flag Management System (2025-09-12): Implemented comprehensive feature flag system for controlled rollouts. Database: `feature_flags` table with name, display_name, description, enabled_for (production/beta/admin/super_admin), enabled_user_ids, rollout_percentage. `feature_flag_audit` table tracks all changes. RLS policies restrict management to super admins only. UI: Feature Flag Management page at `/admin/feature-flags` with create/edit/delete, toggle active/inactive, percentage rollout slider, user targeting, audit history. Enhanced BetaFeature component accepts `featureFlag` prop for new system while maintaining backward compatibility with `is_beta_tester`. New `useFeatureFlag` hook checks multiple conditions: active status, user groups, specific users, rollout percentage. Migrated playstyle feature to use `playstyle_ratings` flag. Benefits: granular control per feature (not all-or-nothing), gradual rollouts, emergency kill switches, no code changes needed for enable/disable. Located in: `/src/hooks/useFeatureFlag.tsx`, `/src/pages/admin/FeatureFlagManagement.tsx`.
- Team Balancing Algorithm Refinements (2025-01-17): Enhanced tier-based snake draft algorithm for better team balance. Key improvements: 1) **Weight Redistribution**: Adjusted to 65% skills, 15% attributes, 20% performance (from 60/20/20) to prioritize core abilities while preventing playstyle from overshadowing skill. 2) **Dynamic Attribute Thresholds**: Implemented adaptive thresholds based on improvement score - more lenient for significant improvements (>0.2 gets 1.5 threshold, >0.09 gets 1.1). 3) **Win Rate Gap Protection**: Penalty only applies when gap exceeds 10% AND worsens by >50%, preventing over-penalization. 4) **Multiple Optimization Rounds**: Algorithm now runs up to 3 rounds to find cascading improvements. 5) **Enhanced Debug Logging**: Shows specific metric changes (e.g., "Attack: 0.02â†’0.20") and clear rejection reasons with attribute imbalance values. Located in `tierBasedSnakeDraft.ts` with new `getAttributeBalanceThreshold()` and `generateComprehensiveSwapAnalysis()` functions. Documentation: `/docs/TierBasedSnakeDraftImplementation.md`.
- Formation Suggester Overhaul (2025-09-17): Integrated playstyle attributes into formation suggestion system. Major improvements: 1) **6-Attribute Position Scoring**: Uses Pace, Shooting, Passing, Dribbling, Defending, Physical for position suitability. 2) **Natural Position Detection**: Maps 24 playstyles to ideal tactical positions (e.g., "Finisher" â†’ ST, "Engine" â†’ CM/W/CAM). 3) **Relative Requirements**: All position requirements calculated using standard deviation and percentiles from player pool, no hardcoded thresholds. 4) **Three-Phase Assignment**: Natural fits (Phase 1), best available (Phase 2), forced assignments (Phase 3). 5) **Critical Mismatch Handling**: Players with position scores < 2.0 get priority swaps, hierarchy rules bypassed for critical fixes. 6) **Database Trigger Fix**: Fixed `update_player_derived_attributes()` to include custom attribute ratings alongside predefined playstyles. 7) **Individual Benefit Enforcement**: Both players must improve in swaps. 8) **Consolidated Debug Logging**: Single debug log shows league averages, formation selection, player assignments with scores, and optimization notes. Formations: 3-2W-2-1, 3-4-1, 3-1-3-1, 3-1-2-2 selected based on team composition. Located in `formationSuggester.ts`. Documentation: `/docs/features/FormationSuggester.md`.
- Team Balancing Optimization Breakthrough (2025-09-22): Major improvements to tier-based snake draft algorithm achieving 80% better balance (0.216 vs 1.061). Key changes: 1) **Attribute Balance Calculation**: Switched from MAX to weighted average with penalty multipliers (25% for >3.0, 50% for >4.0), preventing single large differences from blocking all swaps. 2) **Dynamic Threshold System**: Multi-factor adjustments based on improvement magnitude (0.05â†’1.0, 0.1â†’1.5, 0.2â†’2.0, 0.3â†’2.5), current balance score (+30% per unit >1.0), and failed attempts (progressive: 5â†’+25%, 10â†’+50%, 20â†’+100%). 3) **Multi-Pass Strategy**: Three optimization passes with different attribute multipliers - Pass 1: Skills Focus (2x threshold), Pass 2: Balanced (1x), Pass 3: Fine-tuning (0.8x). 4) **Swap Priority System**: Added `calculateSwapPriority()` function weighting skill improvement (40%), individual skills (30%), win rate (20%), attribute penalty (-10%). 5) **Fallback Strategies**: Activates when no swaps made and balance >1.5x threshold, uses extreme relaxation (30 failed attempts parameter). 6) **Enhanced Debug Logging**: Shows weighted decision scores, specific rejection reasons (attribute/tier/minimal), and transparent constraint identification. Result: Algorithm now successfully makes 3-5 beneficial swaps instead of 0, creating genuinely competitive teams. Trade-off: Accepts some tier concentration for significantly better overall balance. Located in `tierBasedSnakeDraft.ts`.

## Core Development Commands

### Local Development
```bash
npm install    # Install dependencies
npm run dev    # Start development server on http://localhost:5173
```

### Build & Production
```bash
npm run build   # TypeScript check + production build
npm run preview # Preview production build locally
```

### Code Quality
```bash
npm run lint    # ESLint checks (max warnings: 0)
```

[... rest of the existing content remains unchanged ...]