# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Memories
- Run date via base before adding/editing any documentation to ensure you've got the correct date.
- Academy tier added (2025-06-18): Players with 0 caps and 0 XP are now "Academy" (deep teal gradient), while players with >0 caps and 0 XP remain "Retired" (black). This distinction helps differentiate new players from inactive ones.
- When the user wants to commit changes to GitHub, ask if they'd like to use the Git MCP server commands instead of bash git commands.
- Team Announcement Phase enhanced (2025-06-18): Now supports two-stage pasting - first paste player registration message, then team announcement message with ðŸŸ  Orange Team and ðŸ”µ Blue Team sections. Attack/Defense ratings removed from game creation form. Default pitch cost updated to Â£54.
- Game IQ Rating added (2025-06-26): Third rating metric alongside Attack and Defense. Measures tactical awareness, positioning, and decision-making (0-10 scale, displayed as 0-5 stars). Team balancing now uses 5 metrics with 20% weighting each: Attack, Defense, Game IQ, Win Rate, Goal Differential. Database columns: `game_iq_rating` in player_ratings, `game_iq` and `average_game_iq_rating` in players table.
- Game IQ Implementation Details (2025-06-26): When working with player ratings, always handle null values using nullish coalescing (`??`) or optional chaining (`?.`). The admin ratings page uses OR logic for filtering (shows players with at least one non-zero rating). Rating interfaces must include `gameIq` in addition to `attack` and `defense`. All player rating displays should show Game IQ alongside Attack and Defense ratings.
- Game IQ Display Improvements (2025-06-26): Unrated values show as "unrated" instead of "0" or "NaN". Created `formatRating()` and `formatStarRating()` helper functions in `/src/utils/ratingFormatters.ts`. Rating buttons show contextual text: "ADD GAME IQ RATING" when only Game IQ is missing, "COMPLETE RATING" when multiple ratings are missing, "UPDATE RATING" when all ratings exist.
- Changelog Management: Version 1.2.0 added for Game IQ feature. When documenting team balancing changes in user-facing content, keep algorithm details vague to prevent gaming the system. Players can rate other players (not just teammates) after playing 5+ games together.
- Ratings Explanation Component (2025-06-26): Added expandable/collapsible explanation section to ratings page using Framer Motion. Component path: `/src/components/ratings/RatingsExplanation.tsx`. Explains that ratings should consider both skill AND position tendency (e.g., a skilled defender who rarely plays defense should have a lower defense rating). Emphasizes confidentiality and importance of honest ratings. Keep algorithm details vague - only mention it "considers multiple factors beyond just ratings" without specifics.
- Admin Ratings Page Fix (2025-06-26): Fixed Game IQ ratings not displaying in admin panel. Issue was in `useRaterStats` hook missing `game_iq_rating` in select query. Also added `updated_at` column to `player_ratings` table with auto-update trigger, so admin can see when ratings were last modified instead of just creation date.
- Changelog Deep Linking (2025-06-26): Added URL fragment support to link directly to specific changelog versions. Access via `http://localhost:5173/changelog#1.2.0` format. The linked version auto-expands with all sections (Added/Changed/Fixed) visible. Implementation uses refs to control DaisyUI collapse component state. Existing "Expand All"/"Collapse All" functionality remains intact.
- Rating History System (2025-06-27): Implemented player_ratings_history table to track all rating changes. Database trigger automatically logs INSERT and UPDATE operations. Recent Activity now shows rating changes with visual indicators: ðŸŸ¢â†‘ for increases, ðŸ”´â†“ for decreases. Changes display the amount (e.g., "+2", "-1"). History table has RLS policies: INSERT allowed for trigger operations, SELECT limited to admins only. Fixed RLS policy error by adding "Allow trigger to insert history" policy. User-specific activity filtering available when selecting a rater. Recent Activity section on admin ratings page shows most recent changes at top with mobile-responsive design.
- Admin Players Page Mobile Improvements (2025-06-26): Made admin players management page mobile-friendly. Key changes: responsive header controls with stacked layout, mobile-optimized search bar (full width), abbreviated button labels on mobile, hidden table columns (Caps/XP) with inline badges, mobile-specific "Select All" button, improved touch targets with appropriate sizing (btn-sm/btn-xs), reduced container padding. Pattern can be applied to other admin pages for consistency.
- Role-Based Access Control (RBAC) System (2025-06-26): Implemented granular permissions for admins. Database: `roles` table for named roles, `role_permissions` for role-permission mappings, `role_id` added to `admin_roles`. Created 5 default roles: Super Admin (all permissions), Full Admin (all except admin/ratings management), Treasurer (payments only), Team Manager (games/teams), Player Manager (players/tokens). 10 permissions available: manage_games, manage_players, manage_teams, manage_payments, manage_history, manage_tokens, manage_accounts, manage_slots, manage_admins (super only), manage_ratings (super only). Backward compatible with existing `is_admin` and `is_super_admin` flags.
- RBAC UI Implementation (2025-06-26): Role management at `/admin/roles` for super admins only. Admin management page redesigned with stats header, role assignment, search functionality, and improved layout. Uses custom expandable sections instead of DaisyUI collapse for View Permissions due to rendering issues with dynamic content. Admin cards show role badges: red for Super Admin, blue for Full Admin, purple for role-based with role name. Grid layout: 1 col mobile, 2 col medium, 3 col large, 4 col extra-large screens.
- RBAC Permission Checking (2025-06-26): Updated `useAdmin` hook to include `hasPermission(permission)` and `permissions[]`. Admin portal shows only permitted sections. Payment dashboard example: checks `PERMISSIONS.MANAGE_PAYMENTS` before allowing access. Permission constants in `/src/types/permissions.ts`. Admin fetching uses two queries (players + admin_roles) combined in memory to handle all admin types correctly.
- View As Feature (2025-06-26): Super admins can emulate other admin users' permissions via "View As" button in admin management. Implementation: ViewAsContext (`/src/context/ViewAsContext.tsx`) manages emulated state, useAdmin hook checks for overrides, ViewAsIndicator shows warning banner. Access via Admin Portal â†’ Admin Management â†’ View As button. Exit via banner button returns to normal permissions.
<<<<<<< HEAD
- Player Rating Decimal Precision Fix (2025-06-27): Fixed issue where average ratings were stored as integers after Game IQ implementation. Root cause: bulk update rounded averages (e.g., 4.0 instead of 3.29). Solution: Applied migration to recalculate all averages from individual ratings. The trigger function `update_player_average_ratings()` was already correct and maintains decimal precision for all future updates. Documentation: `/docs/fixes/RatingDecimalPrecisionFix.md`.
- All Ratings Average Calculation Fix (2025-07-08): Fixed issue where Attack, Defense, and Game IQ ratings were storing individual values instead of averages. Examples: Zhao's Game IQ showed 2 instead of 4 (avg of 2,3,5,6), Mike M's Attack showed 0 instead of 5.29. Root cause: incorrect data values, not the trigger function. Solution: Applied migration to recalculate all rating averages using AVG() function. Trigger verified working correctly for future updates. Documentation: `/docs/fixes/GameIQAverageCalculationFix.md`.
=======
- Game IQ Team Balancing Fix (2025-06-30): Fixed Game IQ not being fetched or displayed in team balancing. Issues: `useTeamBalancing` hook wasn't querying `game_iq` from database, OptimalTeamGenerator and SwapSuggestion components didn't show Game IQ, values were defaulting to 5. Fixed by: adding `game_iq` and `average_game_iq_rating` to database query, updating all components to display Game IQ with null-safe operators (`??`), adding Game IQ to team stats calculations with proper weighting. All rating interfaces updated to handle null values, using `formatRating()` utility to display "unrated" for null values.
- Unknown Player Distribution in Team Balancing (2025-06-30): Enhanced team generation algorithm to distribute players with unknown stats (< 10 games) evenly across teams. Previously, unknowns could cluster on one team, disabling win rate/goal differential metrics. New two-phase approach: Phase 1 distributes unknowns evenly, Phase 2 optimizes experienced players. Added UI indicators: "NEW" badges for < 10 game players, team headers show new player count, confidence score (high/medium/low) based on unknown percentage. Helper function `isUnknownPlayer()` in teamBalanceUtils.ts identifies players with insufficient data.
- Deterministic Unknown Distribution (2025-06-30): Fixed non-deterministic team generation. Previous implementation used random shuffling for unknowns. New approach: Phase 1 finds OPTIMAL distribution of unknowns by trying all combinations and selecting best Attack/Defense/Game IQ balance. Uses `generateCombinationsOfSize()` to generate all possible splits, `calculatePartialBalanceScore()` to evaluate based on 3 known metrics only, `findOptimalUnknownDistribution()` to select best split. Result: same optimal configuration every time, unknowns distributed based on their actual stats, truly deterministic algorithm.
>>>>>>> 94109b20dd5d5927ac3a9d1adbd2f0048cb8c0fc

## Core Development Commands

### Local Development
```bash
npm install    # Install dependencies
npm run dev    # Start development server on http://localhost:5173
```

### Build & Production
```bash
npm run build   # TypeScript check + production build
npm run preview # Preview production build locally
```

### Code Quality
```bash
npm run lint    # ESLint checks (max warnings: 0)
```

[... rest of the existing content remains unchanged ...]